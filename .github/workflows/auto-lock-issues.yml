name: ğŸš« Auto-close PRs During Restricted Window

on:
  pull_request:
    types: [opened]

jobs:
  close-pr-in-window:
    runs-on: ubuntu-latest
    permissions:
      issues: write       # ç”¨äºå‘è¡¨è¯„è®º
      pull-requests: write  # ç”¨äºå…³é—­ PR

    steps:
      - name: Determine if we're in the restricted window
        id: timecheck
        run: |
          # è·å– UTC æ—¶é—´å’Œæ˜ŸæœŸå‡ 
          now_utc=$(date -u +"%H:%M")
          weekday=$(date -u +"%u")   # 1=Mon ... 7=Sun

          # è®¡ç®—çª—å£ï¼šåŒ—äº¬æ—¶é—´å‘¨æ—¥ 12:30â€“22:00 å¯¹åº” UTC å‘¨æ—¥ 04:30â€“14:00
          # æ‰€ä»¥ï¼šweekday==7 ä¸” now_utc åœ¨ 04:30â€“14:00 ä¹‹é—´
          start="04:30"; end="14:00"
          in_window=false

          if [ "$weekday" -eq "7" ] && [[ "$now_utc" > "$start" && "$now_utc" < "$end" ]]; then
            in_window=true
          fi

          echo "in_window=$in_window" >> $GITHUB_OUTPUT

      - name: Close PR if in restricted window
        if: steps.timecheck.outputs.in_window == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.number }}
        run: |
          echo "Pull Request #$PR_NUMBER opened during disabled window â€“ closing it."
          # 1) ç•™ä¸€æ¡è¯„è®ºè¯´æ˜åŸå› 
          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" \
            -d '{"body": "âš ï¸ å½“å‰æ—¶é—´ä¸ºåŒ—äº¬æ—¶é—´å‘¨æ—¥ 12:30â€“22:00ï¼ŒPull Request æäº¤æš‚æ—¶è¢«ç¦æ­¢ï¼Œè¯·åœ¨ 22:00 åå†å°è¯•ã€‚"}'

          # 2) å…³é—­ PR
          curl -s -X PATCH \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER" \
            -d '{"state":"closed"}'
