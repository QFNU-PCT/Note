name: Weekly PR Reset and Creation

on:
  schedule:
    # 每周周日北京时间22:05，稍晚于允许PR任务
    - cron: '5 14 * * 0'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  reset-and-create-prs:
    runs-on: ubuntu-latest
    env:
      ORG: QFNU-PCT
      REPO: QFNU-PCT/Note
      TOKEN: ${{ secrets.ORG_TOKEN }}

    steps:
      - name: Setup git config
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

      - name: Clone repository
        run: |
          git clone https://x-access-token:${TOKEN}@github.com/${REPO}.git repo

      - name: Close all open PRs
        run: |
          prs=$(curl -s -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${REPO}/pulls?state=open&per_page=100" | jq -r '.[].number')
          for pr in $prs; do
            echo "Closing PR #$pr"
            curl -X PATCH -s -H "Authorization: Bearer $TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${REPO}/issues/$pr" \
              -d '{"state":"closed"}'
          done

      - name: Get organization members
        run: |
          page=1
          > members.txt
          while true; do
            logins=$(curl -s -H "Authorization: Bearer $TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/orgs/${ORG}/members?per_page=100&page=$page" \
              | jq -r '.[].login')
            if [ -z "$logins" ]; then
              break
            fi
            echo "$logins" >> members.txt
            ((page++))
          done

      - name: Create PR for each member by copying template.md
        run: |
          cd repo
          while read member; do
            echo "Creating PR for member: $member"

            branch="member-pr-$member-$(date +%F)"

            git checkout main
            git pull origin main
            git checkout -b $branch

            # 覆盖写入 template.md，保证文件变化
            echo -e "---\ntitle: \ndate: \ncategories: note\ntags: \n---" > template.md

            git add template.md
            git commit -m "chore: 添加 template.md 给成员 $member"

            # 先 fetch 远程分支，避免推送被拒绝
            git fetch origin $branch || true

            if git show-ref --verify --quiet refs/remotes/origin/$branch; then
              if ! git rebase origin/$branch; then
                echo "Rebase 失败，放弃该成员 PR 创建"
                git rebase --abort
                exit 1
              fi
            fi

            git push -u origin $branch

            pr_title="自动 PR - 会员同步: $member"
            pr_body="这是为组织成员 $member 自动创建的 PR。"

            curl -s -H "Authorization: Bearer $TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              -d "{\"title\":\"$pr_title\",\"head\":\"$branch\",\"base\":\"main\",\"body\":\"$pr_body\"}" \
              "https://api.github.com/repos/${REPO}/pulls"

            git checkout main
            git branch -D $branch
          done < ../members.txt
